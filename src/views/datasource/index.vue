<template>
    <div class="container">
        <Breadcrumb :items="['系统管理', '数据源管理']" />
        <a-card class="general-card" title="数据源管理">
            <!-- 搜索表单 -->
            <a-row>
                <a-col :flex="1">
                    <a-form
                        :model="formModel"
                        :label-col-props="{ span: 6 }"
                        :wrapper-col-props="{ span: 18 }"
                        label-align="left"
                    >
                        <a-row :gutter="16">
                            <a-col :span="6">
                                <a-form-item field="id" label="数据源ID">
                                    <a-input-number v-model="formModel.id" placeholder="请输入数据源ID" :min="1" />
                                </a-form-item>
                            </a-col>
                            <a-col :span="6">
                                <a-form-item field="name" label="数据源名称">
                                    <a-input v-model="formModel.name" placeholder="请输入数据源名称" />
                                </a-form-item>
                            </a-col>
                            <a-col :span="6">
                                <a-form-item field="remark" label="备注">
                                    <a-input v-model="formModel.remark" placeholder="请输入数据源备注" allow-clear />
                                </a-form-item>
                            </a-col>
                        </a-row>
                    </a-form>
                </a-col>
                <a-divider style="height: 84px" direction="vertical" />
                <a-col :flex="'86px'" style="text-align: right">
                    <a-space direction="vertical" :size="18">
                        <a-button type="primary" @click="search">
                            <template #icon>
                                <icon-search />
                            </template>
                            {{ $t('searchTable.form.search') }}
                        </a-button>
                        <a-button @click="reset">
                            <template #icon>
                                <icon-refresh />
                            </template>
                            {{ $t('searchTable.form.reset') }}
                        </a-button>
                    </a-space>
                </a-col>
            </a-row>
            <a-divider style="margin-top: 0" />
            <!-- 快捷操作栏 -->
            <a-row style="margin-bottom: 16px">
                <a-col :span="12">
                    <a-space>
                        <a-dropdown trigger="hover">
                            <a-button type="primary" v-permission="['sys:role:add']">
                                <template #icon>
                                    <icon-plus />
                                </template>
                                {{ $t('searchTable.operation.create') }}
                            </a-button>
                            <template #content>
                                <a-doption @click="showcreateRole">MySQL</a-doption>
                                <a-doption @click="showcreateRole" disabled>PostgreSQL</a-doption>
                            </template>
                        </a-dropdown>

                        <!-- 新增和更新数据源模态框 -->
                        <a-modal
                            v-model:visible="roleModalvisible"
                            title="数据源信息"
                            @cancel="handleCancel"
                            @before-ok="handleBeforeOk"
                            width="800px"
                            min-width="800px"
                            draggable
                        >
                            <a-form ref="dataSourceModalFormRef" :model="dataSourceModalForm">
                                <a-form-item
                                    field="name"
                                    label="数据源名称"
                                    :rules="[
                                        {
                                            required: true,
                                            message: '数据源名称不能为空'
                                        },
                                        {
                                            minLength: 3,
                                            maxLength: 20,
                                            message: '数据源名称长度为3-20个字符'
                                        }
                                    ]"
                                    :validate-trigger="['blur']"
                                >
                                    <a-input v-model="dataSourceModalForm.name" placeholder="请输入数据源名称" />
                                </a-form-item>

                                <a-form-item
                                    field="jdbcUrl"
                                    label="JDBC URL"
                                    :rules="[
                                        {
                                            required: true,
                                            message: 'URL不能为空'
                                        }
                                    ]"
                                    :validate-trigger="['blur']"
                                >
                                    <a-textarea v-model="dataSourceModalForm.jdbcUrl" placeholder="请输入JDBC URL" allow-clear />
                                </a-form-item>

                                <a-form-item
                                    field="username"
                                    label="用户名"
                                    :rules="[
                                        {
                                            required: true,
                                            message: '用户名不能为空'
                                        }
                                    ]"
                                    :validate-trigger="['blur']"
                                >
                                    <a-input v-model="dataSourceModalForm.username" placeholder="请输入用户名" />
                                </a-form-item>

                                <a-form-item
                                    field="password"
                                    label="密码"
                                    :rules="[
                                        {
                                            required: true,
                                            message: '密码不能为空'
                                        }
                                    ]"
                                    :validate-trigger="['blur']"
                                >
                                    <a-input-password v-model="dataSourceModalForm.password" placeholder="请输入密码" />
                                </a-form-item>

                                <a-form-item field="remark" label="备注">
                                    <a-textarea v-model="dataSourceModalForm.remark" placeholder="请输入备注" allow-clear />
                                </a-form-item>

                                <a-form-item>
                                    <a-button type="dashed" status="success" @click="testConnection">测试连接</a-button>
                                </a-form-item>
                            </a-form>
                        </a-modal>
                    </a-space>
                </a-col>

                <a-col :span="12" style="display: flex; align-items: center; justify-content: end">
                    <a-tooltip :content="$t('searchTable.actions.refresh')">
                        <div class="action-icon" @click="search"><icon-refresh size="18" /></div>
                    </a-tooltip>
                    <a-dropdown @select="handleSelectDensity">
                        <a-tooltip :content="$t('searchTable.actions.density')">
                            <div class="action-icon"><icon-line-height size="18" /></div>
                        </a-tooltip>
                        <template #content>
                            <a-doption
                                v-for="item in densityList"
                                :key="item.value"
                                :value="item.value"
                                :class="{ active: item.value === size }"
                            >
                                <span>{{ item.name }}</span>
                            </a-doption>
                        </template>
                    </a-dropdown>
                </a-col>
            </a-row>
            <!-- 搜索结果表 -->
            <a-table
                row-key="id"
                column-resizable
                :loading="loading"
                :pagination="pagination"
                :data="renderData"
                :bordered="false"
                :size="size"
                @page-change="onPageChange"
            >
                <template #columns>
                    <a-table-column title="#" data-index="" width="50">
                        <template #cell="{ rowIndex }">
                            {{ rowIndex + 1 + (pagination.current - 1) * pagination.pageSize }}
                        </template>
                    </a-table-column>
                    <a-table-column title="ID" data-index="id" width="50" max-width="50"></a-table-column>
                    <a-table-column title="类型" data-index="dbType" width="100" max-width="100">
                        <template #cell="{ record }">
                            <svg
                                v-if="record.dbType === 1"
                                t="1728980553886"
                                class="icon"
                                viewBox="0 0 1417 1024"
                                version="1.1"
                                xmlns="http://www.w3.org/2000/svg"
                                p-id="5292"
                                width="40"
                                height="40"
                            >
                                <path
                                    d="M969.176615 98.540308a65.220923 65.220923 0 0 0-16.226461 1.96923v0.787693h0.787692c3.229538 6.144 8.664615 10.633846 12.681846 16.068923 3.150769 6.301538 5.907692 12.603077 9.137231 18.904615l0.787692-0.787692c5.513846-3.938462 8.270769-10.24 8.27077-19.692308-2.363077-2.835692-2.678154-5.592615-4.726154-8.349538-2.363077-3.938462-7.404308-5.907692-10.633846-8.979693l-0.07877 0.07877z m-628.263384 779.500307h-54.823385a3004.258462 3004.258462 0 0 0-15.911384-260.568615h-0.472616l-83.337846 260.568615h-41.668923L61.991385 617.472H61.44c-6.459077 86.646154-10.24 173.607385-11.500308 260.568615H0c3.229538-116.184615 11.342769-225.122462 24.182154-326.734769h67.977846l78.848 240.088616h0.472615L251.037538 551.384615h64.748308a3540.676923 3540.676923 0 0 1 25.206154 326.73477h-0.078769z m237.252923-241.033846c-22.291692 120.753231-51.751385 208.738462-88.142769 263.483077-28.435692 42.299077-59.628308 63.330462-93.499077 63.330462a92.16 92.16 0 0 1-33.476923-8.113231v-29.144615c6.537846 0.945231 14.178462 1.496615 22.843077 1.496615a55.138462 55.138462 0 0 0 38.203076-13.154462c11.657846-10.633846 17.486769-22.528 17.48677-35.682461 0-9.216-4.568615-27.805538-13.627077-55.768616l-59.864616-186.446769h53.720616l42.929231 139.421539c9.688615 31.665231 13.784615 53.720615 12.130461 66.323692 23.630769-62.857846 40.014769-131.544615 49.309539-205.745231h51.987692z m793.836308-195.190154c-31.586462-0.787692-56.083692 2.363077-76.642462 11.027693-5.907692 2.363077-15.36 2.363077-16.147692 9.924923 3.229538 3.150769 3.702154 8.270769 6.459077 12.603077 4.726154 7.876923 12.918154 18.510769 20.48 24.103384 8.270769 6.459077 16.541538 12.760615 25.206153 18.274462 15.36 9.452308 32.768 15.044923 47.812924 24.576 8.664615 5.513846 17.329231 12.603077 25.993846 18.510769 4.332308 2.914462 7.089231 8.270769 12.681846 10.161231v-1.181539c-2.756923-3.544615-3.544615-8.664615-6.222769-12.603077-3.938462-3.938462-7.876923-7.561846-11.815385-11.421538a190.385231 190.385231 0 0 0-41.038769-39.936c-12.603077-8.664615-40.329846-20.637538-45.528616-35.131077l-0.787692-0.787692c8.664615-0.787692 18.904615-3.938462 27.254154-6.301539 13.390769-3.544615 25.678769-2.756923 39.542154-6.301538 6.301538-1.575385 12.603077-3.465846 18.904615-5.513846v-3.544616c-7.089231-7.089231-12.366769-16.699077-19.692308-23.315692a523.815385 523.815385 0 0 0-65.220923-48.600615c-12.445538-7.876923-28.120615-12.996923-41.196307-19.692308-4.726154-2.363077-12.603077-3.623385-15.36-7.561846-7.089231-8.664615-11.264-20.086154-16.226462-30.404923a1045.110154 1045.110154 0 0 1-32.295384-68.68677c-7.089231-15.438769-11.421538-30.877538-20.086154-45.056-40.802462-67.190154-84.913231-107.913846-152.812308-147.692307-14.572308-8.270769-32.059077-11.815385-50.569846-16.226462-9.846154-0.472615-19.692308-1.181538-29.538462-1.575384-6.459077-2.756923-12.760615-10.24-18.274461-13.863385-22.528-14.178462-80.659692-44.898462-97.122462-4.253538-10.712615 25.6 15.753846 50.884923 24.891077 63.881846 6.774154 9.058462 15.36 19.377231 20.086154 29.538461 2.756923 6.852923 3.544615 13.942154 6.301538 21.031385 6.301538 17.329231 12.209231 36.785231 20.48 53.011692a181.169231 181.169231 0 0 0 14.651077 24.418462c3.150769 4.332308 8.664615 6.301538 9.846154 13.390769-5.513846 8.034462-5.907692 19.692308-9.058461 29.538461-14.178462 44.740923-8.664615 100.036923 11.421538 132.962462 6.301538 9.767385 21.346462 31.507692 41.511385 23.158154 17.723077-7.089231 13.863385-29.538462 18.904615-49.309539 1.181538-4.726154 0.393846-7.876923 2.835692-11.027692v0.866462c5.513846 11.106462 11.106462 21.661538 16.226462 32.768 12.130462 19.377231 33.398154 39.463385 51.2 52.932923 9.452308 7.089231 16.935385 19.377231 28.750769 23.709538v-1.181538h-0.866461c-2.520615-3.387077-5.907692-5.041231-9.137231-7.876923a203.539692 203.539692 0 0 1-20.637539-23.63077 517.513846 517.513846 0 0 1-44.110769-71.916307c-6.537846-12.445538-11.972923-25.757538-17.171692-37.96677-2.363077-4.726154-2.363077-11.815385-6.301539-14.178461-5.907692 8.664615-14.572308 16.068923-18.904615 26.781538-7.483077 16.935385-8.270769 37.809231-11.106461 59.628308-1.575385 0.393846-0.787692 0-1.575385 0.787692-12.603077-3.072-17.014154-16.147692-21.661539-27.175384-11.815385-28.041846-13.784615-73.097846-3.544615-105.393231 2.756923-8.270769 14.572308-34.422154 9.846154-42.299077-2.520615-7.561846-10.24-11.815385-14.572308-17.959385-5.513846-7.876923-10.318769-16.305231-14.178461-25.206153-9.452308-22.055385-14.178462-46.473846-24.497231-68.608-4.726154-10.24-12.996923-20.952615-19.692308-30.326154-7.561846-10.633846-15.753846-18.116923-21.740307-30.72-1.969231-4.332308-4.726154-11.500308-1.575385-16.226462 0.787692-3.150769 2.363077-4.411077 5.513846-5.277538 5.198769-4.253538 19.771077 1.260308 24.891077 3.623384 14.651077 5.907692 26.939077 11.500308 39.148308 19.692308 5.513846 3.938462 11.500308 11.500308 18.589538 13.390769h8.270769c12.603077 2.835692 26.860308 0.787692 38.675693 4.332308 21.031385 6.774154 39.936 16.541538 56.871384 27.175385a351.704615 351.704615 0 0 1 123.195077 135.08923c4.726154 9.058462 6.774154 17.329231 11.027693 26.781539 8.270769 19.534769 18.510769 39.227077 26.939076 58.052923 8.270769 18.668308 16.226462 37.572923 28.120616 53.011692 5.907692 8.270769 29.617231 12.603077 40.251077 16.935385 7.876923 3.544615 20.086154 6.774154 27.175384 11.027692 13.627077 8.349538 26.781538 17.801846 39.620923 26.860308 6.459077 4.489846 26.151385 14.336 27.332924 22.370461z"
                                    fill="#13748E"
                                    p-id="5293"
                                ></path>
                                <path
                                    d="M1306.308923 878.040615h-155.411692V551.305846h52.302769v286.562462h103.108923zM976.187077 546.343385c84.913231 0 127.291077 54.114462 127.291077 162.264615 0 58.761846-12.681846 103.187692-38.281846 133.12a126.818462 126.818462 0 0 1-15.044923 14.729846l60.022153 29.538462h0.157539l-21.267692 36.706461-78.296616-45.607384a150.212923 150.212923 0 0 1-42.771692 5.828923c-41.747692 0-72.861538-12.130462-93.577846-36.312616-22.685538-26.781538-33.870769-69.001846-33.870769-126.424615 0-58.446769 12.760615-102.636308 38.203076-132.647385 23.315692-27.490462 55.847385-41.196308 97.437539-41.196307z m-5.356308 40.172307c-50.018462 0-75.067077 41.275077-75.067077 123.510154 0 47.025231 6.616615 81.289846 19.928616 102.557539 12.209231 20.007385 31.350154 29.932308 57.659077 29.932307 50.018462 0 75.067077-41.668923 75.067077-124.612923 0-46.473846-6.695385-80.344615-19.928616-101.769846-12.209231-19.692308-31.507692-29.538462-57.659077-29.538461zM817.782154 787.534769c0 27.726769-10.24 50.569846-30.483692 68.292923-20.322462 17.723077-47.497846 26.545231-81.841231 26.545231-32.059077 0-62.779077-10.161231-92.947693-30.404923l14.099693-28.120615c25.836308 12.996923 49.152 19.377231 70.262154 19.37723 19.613538 0 35.052308-4.332308 46.237538-12.996923a44.504615 44.504615 0 0 0 17.723077-36.312615c0-19.534769-13.548308-36.076308-38.281846-49.939692-22.843077-12.603077-68.686769-38.833231-68.686769-38.833231-24.891077-18.116923-37.336615-37.572923-37.336616-69.553231 0-26.545231 9.294769-47.812923 27.805539-64.039385 18.589538-16.462769 42.535385-24.576 72.073846-24.576 30.168615 0 57.816615 8.034462 82.707692 24.260924l-12.603077 28.120615a161.004308 161.004308 0 0 0-62.857846-13.627077c-16.777846 0-29.696 4.017231-38.596923 12.209231a40.487385 40.487385 0 0 0-14.729846 30.956307c0 19.377231 13.863385 35.997538 39.384615 50.176 23.236923 12.760615 70.104615 39.620923 70.104616 39.620924 25.6 18.038154 38.281846 37.179077 38.281846 69.001846l-0.315077-0.157539z"
                                    fill="#F28D05"
                                    p-id="5294"
                                ></path>
                            </svg>
                            <svg
                                v-if="record.dbType === 2"
                                t="1728981280241"
                                class="icon"
                                viewBox="0 0 1024 1024"
                                version="1.1"
                                xmlns="http://www.w3.org/2000/svg"
                                p-id="7324"
                                width="40"
                                height="40"
                            >
                                <path
                                    d="M930.56415839 579.12956914c-14.30569336-12.26202276-32.69872793-14.30569336-51.09176337-8.17468154-14.30569336 4.08734121-30.65505732 6.13101182-44.96075156 6.13101094 40.87341035-67.44112734 71.52846768-141.01326563 91.96517373-218.67274424 10.21835214-34.74239854 16.34936396-71.52846768 16.34936396-110.35820831 4.08734121-30.65505732-4.08734121-61.31011552-22.48037578-85.83416102-51.0917625-65.39745674-130.7949126-102.18352588-212.5417333-100.13985528h-6.13101181c-34.74239854 0-69.48479707 6.13101182-102.18352588 14.30569336h-2.04367061c-20.43670518-4.08734121-42.91708096-6.13101182-63.35378525-6.13101182-38.82973974-2.0436706-79.7031501 8.17468242-114.44554864 28.6113876-49.04809277-18.39303457-104.22719648-26.567717-157.36262959-24.52404639-49.04809277 0-98.09618467 20.43670518-132.83858408 55.17910371-36.78606914 38.82973974-55.17910371 98.09618467-53.13543311 181.88667598 4.08734121 36.78606914 10.21835214 73.57213828 18.39303458 108.31453681 12.26202276 53.1354331 26.567717 104.22719648 44.96075156 155.31895898 14.30569336 47.00442217 38.82973974 91.96517286 71.52846767 128.75124288 16.34936396 16.34936396 38.82973974 26.567717 63.35378614 28.61138672 18.39303457 0 34.74239854-8.17468242 49.04809189-20.4367043 12.26202276 14.30569336 28.6113876 22.48037578 47.00442217 26.56771612 24.52404638 6.13101182 49.04809277 8.17468242 73.57213828 4.08734121 12.26202276-2.0436706 22.48037578-6.13101182 32.69872881-10.21835303 0 12.26202276 0 24.52404638 2.0436706 36.78607002-2.0436706 36.78606914 4.08734121 71.52846768 14.30569336 106.27086621 4.08734121 20.43670518 14.30569336 38.82973974 28.61138672 55.17910372 28.6113876 26.567717 67.44112734 36.78606914 104.22719648 28.61138759 38.82973974-6.13101182 75.61580888-26.567717 98.09618468-57.22277431 26.567717-36.78606914 38.82973974-91.96517286 40.87341034-179.84300538 0-4.08734121 2.0436706-8.17468242 2.04367061-12.26202275h6.13101182c34.74239854 2.0436706 69.48479707-4.08734121 100.13985439-16.34936484 24.52404638-10.21835214 47.00442217-26.567717 63.35378613-49.0480919 4.08734121-8.17468242 8.17468242-16.34936396 10.21835304-24.52404639 2.0436706-16.34936396-4.08734121-30.65505732-16.34936397-40.87341035z m-12.26202362 47.00442217c-14.30569336 18.39303457-30.65505732 30.65505732-53.13543311 38.82973975-24.52404638 10.21835214-51.0917625 14.30569336-77.65947949 14.30569336-12.26202276 0-24.52404638-2.0436706-36.78606914-4.08734122-6.13101182 51.0917625-10.21835214 102.18352588-20.43670517 153.27528926-2.0436706 24.52404638-14.30569336 49.04809277-30.65505821 69.48479707-20.43670518 18.39303457-44.96075156 30.65505732-71.52846767 32.69872793-30.65505732 8.17468242-61.31011552 2.0436706-85.83416192-16.34936397-14.30569336-12.26202276-24.52404638-30.65505732-32.69872793-49.04809189-4.08734121-12.26202276-6.13101182-22.48037578-8.17468242-34.74239941-2.0436706-18.39303457-4.08734121-36.78606914-4.08734033-53.13543311-2.0436706-32.69872793-2.0436706-63.35378614-2.04367061-94.00884345-16.34936396 14.30569336-36.78606914 24.52404638-57.22277432 28.6113876-20.43670518 4.08734121-42.91708096 2.0436706-63.35378612-4.08734122-6.13101182-2.0436706-12.26202276-4.08734121-18.39303458-8.17468242-8.17468242-2.0436706-12.26202276-8.17468242-16.34936396-14.30569336-2.0436706-4.08734121-4.08734121-10.21835214-2.04367061-14.30569336 2.0436706-4.08734121 4.08734121-10.21835214 8.17468155-12.26202363 10.21835214-6.13101182 20.43670518-10.21835214 32.6987288-12.26202276 14.30569336-2.0436706 28.6113876-6.13101182 42.91708008-12.26202363 8.17468242-6.13101182 14.30569336-14.30569336 20.43670518-22.4803749v-2.04367061c-18.39303457 0-34.74239854-6.13101182-51.0917625-12.26202363-6.13101182 6.13101182-32.69872793 34.74239854-69.48479708 77.65947949-12.26202276 16.34936396-28.6113876 26.567717-49.04809277 28.6113876-18.39303457 0-34.74239854-8.17468242-47.00442216-20.43670517-30.65505732-34.74239854-51.0917625-75.61580888-65.39745586-118.53288985-16.34936396-53.1354331-30.65505732-104.22719648-40.87341036-155.31895898-8.17468242-34.74239854-14.30569336-67.44112734-18.39303456-102.18352588-4.08734121-77.65947949 14.30569336-128.751242 44.96075068-161.44997081 30.65505732-30.65505732 71.52846768-47.00442217 116.48922011-49.04809188 55.17910371-2.0436706 110.35820742 8.17468242 161.44996992 28.61138671 32.69872793-20.43670518 69.48479707-30.65505732 108.3145377-30.65505733 20.43670518 0 42.91708096 4.08734121 63.35378613 8.17468242 8.17468242-4.08734121 18.39303457-6.13101182 28.61138672-8.17468242 26.567717-6.13101182 51.0917625-8.17468242 77.6594795-10.21835302 77.65947949-2.0436706 151.23161777 30.65505732 200.27971054 91.96517373 12.26202276 20.43670518 18.39303457 47.00442217 16.34936397 71.52846767-2.0436706 34.74239854-8.17468242 69.48479707-16.34936397 104.22719649-22.48037578 85.83416191-59.26644492 167.58098174-108.3145377 243.19679062 2.0436706 2.0436706 4.08734121 2.0436706 6.13101182 4.08734122 28.6113876 6.13101182 57.22277432 6.13101182 85.83416192-2.04367061 10.21835214-4.08734121 22.48037578-2.0436706 32.69872793 2.04367061 4.08734121 4.08734121 8.17468242 10.21835214 8.17468242 16.34936396-6.13101182 0-6.13101182 6.13101182-8.17468242 10.21835303z"
                                    p-id="7325"
                                ></path>
                                <path
                                    d="M703.71673086 111.12902158h-6.13101182c-20.43670518 0-42.91708096 2.0436706-63.35378525 8.17468243 40.87341035 18.39303457 77.65947949 49.04809277 106.27086621 83.79049042 16.34936396 22.48037578 30.65505732 44.96075156 42.91708096 71.52846856 4.08734121 10.21835214 8.17468242 18.39303457 10.21835214 24.52404638 0 4.08734121 2.0436706 6.13101182 2.04367061 10.21835216v6.13101181c2.0436706 32.69872793-8.17468242 53.1354331-8.17468154 85.83416103 0 22.48037578 6.13101182 49.04809277 6.13101093 77.6594795 4.08734121 30.65505732-4.08734121 61.31011552-20.43670429 85.83416191 2.0436706 2.0436706 4.08734121 4.08734121 4.08734033 6.13101182 42.91708096-69.48479707 77.65947949-145.10060683 98.09618467-224.80375693 8.17468242-32.69872793 14.30569336-65.39745674 14.30569424-98.09618468 2.0436706-18.39303457-2.0436706-36.78606914-10.21835303-55.1791037-40.87341035-55.17910371-106.27086709-83.79049131-175.75566416-81.74682071z"
                                    fill="#306092"
                                    p-id="7326"
                                ></path>
                                <path
                                    d="M527.9610667 119.30370401c-36.78606914-2.0436706-71.52846768 10.21835214-98.09618467 32.69872792-24.52404638 20.43670518-40.87341035 49.04809277-53.1354331 77.6594795-10.21835214 28.6113876-16.34936396 59.26644492-18.39303458 89.92150312 16.34936396-8.17468242 32.69872793-14.30569336 51.0917625-18.39303545 18.39303457-4.08734121 38.82973974-4.08734121 57.22277432 2.04367061 20.43670518 8.17468242 34.74239854 26.567717 38.82973975 49.04809277 26.567717 120.57656045-8.17468242 165.53731201-20.43670517 202.32338115-6.13101182 12.26202276-10.21835214 24.52404638-12.26202276 36.78606914 2.0436706 0 4.08734121 0 6.13101182-2.0436706 6.13101182 0 14.30569336 2.0436706 20.4367043 4.08734121 12.26202276 6.13101182 22.48037578 16.34936396 26.56771698 30.65505732 2.0436706 4.08734121 2.0436706 8.17468242 2.04367061 10.21835215v6.13101182c-2.0436706 47.00442217-2.0436706 94.00884346 0 141.01326562 0 18.39303457 2.0436706 34.74239854 4.08734121 53.1354331 0 10.21835214 2.0436706 18.39303457 6.13101094 28.6113876 4.08734121 14.30569336 12.26202276 26.567717 24.52404638 36.78606914s30.65505732 16.34936396 63.35378614 10.21835216c20.43670518-2.0436706 40.87341035-12.26202276 57.22277431-26.56771612 12.26202276-16.34936396 20.43670518-34.74239854 22.48037578-55.17910371 8.17468242-38.82973974 20.43670518-153.27528838 22.48037578-173.71199444 0-12.26202276 2.0436706-26.567717 8.17468155-36.78606914 4.08734121-8.17468242 12.26202276-14.30569336 20.43670517-18.39303456 4.08734121-2.0436706 6.13101182-2.0436706 10.21835304-4.08734122-4.08734121-4.08734121-6.13101182-8.17468242-10.21835304-12.26202275-10.21835214-12.26202276-18.39303457-26.567717-24.5240455-40.87341035-4.08734121-6.13101182-6.13101182-12.26202276-10.21835303-18.39303458-6.13101182-10.21835214-10.21835214-20.43670518-18.39303457-32.69872792-14.30569336-26.567717-26.567717-55.17910371-34.74239854-85.83416192-8.17468242-30.65505732-10.21835214-59.26644492 10.21835216-81.7468207 16.34936396-18.39303457 47.00442217-28.6113876 91.96517372-22.48037578-2.0436706-4.08734121-2.0436706-8.17468242-4.0873412-12.26202275-8.17468242-24.52404638-22.48037578-47.00442217-38.82973976-65.39745674-44.96075156-61.31011552-116.48921924-96.05251406-192.10502812-98.09618467l-8.17468242-6.13101093z"
                                    fill="#306092"
                                    p-id="7327"
                                ></path>
                                <path
                                    d="M278.63326426 121.34737461h-14.30569424c-36.78606914 0-73.57213828 14.30569336-98.09618466 40.87341035-26.567717 26.567717-44.96075156 71.52846768-40.87340948 147.14427656 4.08734121 32.69872793 10.21835214 65.39745674 16.34936396 98.09618467 10.21835214 51.0917625 24.52404638 100.13985528 42.91708096 149.18794717 12.26202276 40.87341035 32.69872793 77.65947949 59.26644404 110.3582083 6.13101182 8.17468242 16.34936396 12.26202276 28.6113876 12.26202276 12.26202276-2.0436706 22.48037578-8.17468242 30.65505733-18.39303458 22.48037578-26.567717 44.96075156-53.1354331 67.44112734-75.61580888-34.74239854-28.6113876-51.0917625-73.57213828-42.91708096-118.53288984 2.0436706-24.52404638 4.08734121-49.04809277 4.08734122-75.61580889 0-20.43670518-2.0436706-32.69872793-2.04367061-40.87341036V348.19480127c0-42.91708096 8.17468242-85.83416191 22.48037578-126.70757139 10.21835214-28.6113876 26.567717-55.17910371 49.04809189-77.65948037-34.74239854-12.26202276-71.52846768-18.39303457-108.31453681-20.43670518-6.13101182-2.0436706-10.21835214-2.0436706-14.30569336-2.04366972zM760.93950518 399.28656377c2.0436706-32.69872793 8.17468242-53.1354331 8.17468242-75.61580888-10.21835214-2.0436706-18.39303457-2.0436706-28.6113876-2.04367062-16.34936396-2.0436706-32.69872793 4.08734121-47.00442128 14.30569425-10.21835214 10.21835214-10.21835214 32.69872793-6.13101182 59.26644492 8.17468242 28.6113876 18.39303457 55.17910371 32.69872792 79.7031501 6.13101182 12.26202276 12.26202276 22.48037578 16.34936397 32.69872792 4.08734121 6.13101182 8.17468242 14.30569336 10.21835303 20.43670518 2.0436706 4.08734121 4.08734121 10.21835214 8.17468154 12.26202276 8.17468242-20.43670518 12.26202276-40.87341035 10.21835302-61.31011553 2.0436706-24.52404638-4.08734121-53.1354331-4.0873412-79.7031501z m-14.30569336-61.31011465c0 2.0436706 0 4.08734121-2.0436706 6.13101094-2.0436706 2.0436706-2.0436706 4.08734121-4.08734122 6.13101181-4.08734121 4.08734121-10.21835214 6.13101182-14.30569336 8.17468243-6.13101182 0-10.21835214 0-14.30569336-4.08734121-2.0436706-2.0436706-4.08734121-2.0436706-6.13101182-4.08734122-2.0436706 0-2.0436706-2.0436706-2.0436706-4.0873412s0-4.08734121 2.0436706-6.13101182l4.08734122-4.08734033c6.13101182-4.08734121 14.30569336-6.13101182 20.43670518-6.13101182h10.21835214c2.0436706 0 4.08734121 2.0436706 6.13101182 2.04367061v6.13101181z"
                                    fill="#306092"
                                    p-id="7328"
                                ></path>
                                <path
                                    d="M478.9129748 356.36948369c-2.0436706-14.30569336-10.21835214-26.567717-24.52404638-32.69872881-6.13101182-2.0436706-12.26202276-2.0436706-18.39303457-2.04367061-8.17468242 0-14.30569336 2.0436706-22.48037578 2.04367061-14.30569336 4.08734121-28.6113876 10.21835214-42.91708096 16.34936397-4.08734121 2.0436706-8.17468242 6.13101182-12.26202276 10.21835302 0 6.13101182 2.0436706 18.39303457 2.04367062 36.78606915 0 26.567717 0 53.1354331-4.08734122 77.65947948-10.21835214 55.17910371 26.567717 106.27086709 81.7468207 116.48921924 4.08734121 0 6.13101182 0 10.21835215 2.04367062 4.08734121-12.26202276 10.21835214-26.567717 12.26202275-40.87341036 12.26202276-36.78606914 42.91708096-67.44112734 18.39303545-185.97401631z m-14.30569423 2.04367061l-6.13101094 6.13101093c-4.08734121 4.08734121-10.21835214 6.13101182-16.34936484 4.08734121-6.13101182-2.0436706-10.21835214-4.08734121-14.30569336-10.21835214-2.0436706-2.0436706-4.08734121-4.08734121-4.08734122-6.13101182-4.08734121-4.08734121-4.08734121-6.13101182-4.08734033-8.17468242 0-4.08734121 4.08734121-6.13101182 8.17468155-8.17468154 4.08734121-2.0436706 8.17468242-2.0436706 10.21835302-2.04367061h6.13101094c6.13101182 0 10.21835214 2.0436706 14.30569424 6.13101094 2.0436706 2.0436706 4.08734121 2.0436706 6.13101094 4.08734121s2.0436706 4.08734121 2.0436706 8.17468242c-2.0436706 2.0436706-2.0436706 4.08734121-2.0436706 6.13101182zM777.28886914 611.82829795c-4.08734121 2.0436706-8.17468242 2.0436706-12.26202276 2.04367061-4.08734121 2.0436706-6.13101182 4.08734121-10.21835302 8.17468154-2.0436706 8.17468242-4.08734121 16.34936396-4.08734033 24.52404638 2.0436706 2.0436706 4.08734121 2.0436706 6.13101093 2.04367061 8.17468242 2.0436706 18.39303457 4.08734121 28.6113876 4.08734121 24.52404638 0 47.00442217-4.08734121 69.48479707-12.26202363 12.26202276-6.13101182 24.52404638-12.26202276 34.74239942-22.48037579-53.1354331 10.21835214-79.7031501 8.17468242-98.09618467 0-6.13101182-2.0436706-10.21835214-4.08734121-14.30569424-6.13101093zM476.8693042 615.91563828c-2.0436706 0-6.13101182 0-10.21835303 8.17468242-12.26202276 14.30569336-16.34936396 24.52404638-28.61138672 32.69872794-16.34936396 10.21835214-32.69872793 16.34936396-53.13543398 18.39303456-6.13101182 0-12.26202276 2.0436706-16.34936396 6.13101182l2.0436706 2.04367061c4.08734121 2.0436706 10.21835214 4.08734121 12.26202276 6.13101181 16.34936396 4.08734121 34.74239854 6.13101182 53.13543398 4.08734034 24.52404638-4.08734121 47.00442217-18.39303457 59.26644492-38.82973975 4.08734121-6.13101182 4.08734121-12.26202276 0-18.39303457-2.0436706-6.13101182-8.17468242-12.26202276-12.26202364-14.30569336 0-6.13101182-4.08734121-6.13101182-6.13101093-6.13101182z"
                                    fill="#306092"
                                    p-id="7329"
                                ></path>
                            </svg>
                        </template>
                    </a-table-column>
                    <a-table-column title="数据源名称" data-index="name"></a-table-column>
                    <a-table-column title="JDBC URL" data-index="jdbcUrl" width="500" minWidth="500"></a-table-column>
                    <a-table-column title="用户名" data-index="username"></a-table-column>
                    <a-table-column title="密码" data-index="password"></a-table-column>
                    <a-table-column title="备注" data-index="remark" ellipsis="true" tooltip="true"></a-table-column>
                    <a-table-column title="创建时间" data-index="createTime"></a-table-column>
                    <a-table-column title="更新时间" data-index="updateTime"></a-table-column>
                    <a-table-column title="操作">
                        <template #cell="{ record }">
                            <a-tooltip content="更新数据源信息">
                                <a-link @click="updateRoleFirm(record)" v-permission="['sys:role:edit']">
                                    <template #icon>
                                        <icon-edit />
                                    </template>
                                    编辑
                                </a-link>
                            </a-tooltip>
                        </template>
                    </a-table-column>
                </template>
            </a-table>
        </a-card>
    </div>
</template>

<script lang="ts" setup>
import { computed, ref, reactive, watch, getCurrentInstance, nextTick, onMounted } from 'vue'
import { useI18n } from 'vue-i18n'
import useLoading from '@/hooks/loading'
import {
    pageDataSourceList,
    DataSourceRecord,
    createDataSource,
    DataSourceParams,
    testDataSource,
    editDataSource
} from '@/api/sys-datasource'
import { Pagination } from '@/types/global'
import { Message } from '@arco-design/web-vue'

const { proxy } = getCurrentInstance()!
const baseURL = proxy?.$baseURL
// 定义表格大小类型
type SizeProps = 'mini' | 'small' | 'medium' | 'large'

// 生成表单模型的初始值
const generateFormModel = () => {
    return {
        id: undefined,
        name: '',
        remark: ''
    }
}

// 使用自定义的加载状态 Hook
const { loading, setLoading } = useLoading(true)
// 国际化函数
const { t } = useI18n()
// 定义渲染数据的响应式变量
const renderData = ref<DataSourceRecord[]>([])
// 定义表单模型的响应式变量
const formModel = ref(generateFormModel())

// 表格大小，默认为 'medium'
const size = ref<SizeProps>('small')

// 基础分页配置
const basePagination: Pagination = {
    current: 1, // 当前页
    pageSize: 10, // 每页显示条数
    showJumper: true,
    showTotal: true, // 是否显示数据总数
    showMore: true // 是否显示更多按钮
}
// 分页的响应式变量
const pagination = reactive({
    ...basePagination
})
// 密度列表，用于调整表格大小
const densityList = computed(() => [
    {
        name: t('searchTable.size.mini'),
        value: 'mini'
    },
    {
        name: t('searchTable.size.small'),
        value: 'small'
    },
    {
        name: t('searchTable.size.medium'),
        value: 'medium'
    },
    {
        name: t('searchTable.size.large'),
        value: 'large'
    }
])

// 获取数据的异步函数
const fetchData = async (params: DataSourceParams = { current: 1, pageSize: 10 }) => {
    setLoading(true) // 开始加载
    try {
        const { data } = await pageDataSourceList(params) // 调用 API 获取数据
        renderData.value = data.records // 设置渲染数据
        pagination.current = params.current // 更新当前页
        pagination.total = data.total // 更新总条数
    } catch (err) {
        // 错误处理，可以使用 errorHandler 或其他方式
    } finally {
        setLoading(false) // 加载结束
    }
}

// 重置表单
const reset = () => {
    formModel.value = generateFormModel()
}

// 搜索函数，触发数据获取
const search = () => {
    fetchData({
        ...basePagination,
        ...formModel.value
    } as unknown as DataSourceParams)
}
// 分页变化时的处理函数
const onPageChange = (current: number) => {
    fetchData({ ...basePagination, current })
}

const roleModalvisible = ref(false)
const dataSourceModalFormRef = ref()
const dataSourceModalForm = reactive<DataSourceRecord>({
    id: undefined,
    name: '',
    jdbcUrl: '',
    username: '',
    password: '',
    remark: '',
    dbType: 1
})
const resetDataSourceModalForm = () => {
    dataSourceModalForm.id = undefined
    dataSourceModalForm.name = ''
    dataSourceModalForm.jdbcUrl = ''
    dataSourceModalForm.username = ''
    dataSourceModalForm.password = ''
    dataSourceModalForm.remark = ''
}

const testConnection = async () => {
    const valid = await dataSourceModalFormRef.value.validate()
    try {
        if (valid === undefined) {
            const params: DataSourceRecord = {
                ...dataSourceModalForm
            }
            setLoading(true)
            const data = await testDataSource(params)
            if (data.status) {
                Message.success(data.message)
            } else {
                Message.error(data.message)
            }
        } else {
            Message.error('表单填写错误')
        }
    } catch (err) {
        setLoading(false)
    }
}

const handleBeforeOk = async done => {
    try {
        const valid = await dataSourceModalFormRef.value.validate()
        if (valid === undefined) {
            // 验证通过
            const params: DataSourceRecord = {
                ...dataSourceModalForm
            }
            setLoading(true) // 开始加载
            try {
                if (params.id > 0) {
                    const data = await editDataSource(params) // 调用 API 获取数据
                    if (data.status) {
                        Message.success(data.message)
                        roleModalvisible.value = false
                    } else {
                        Message.error(data.message)
                    }
                } else {
                    const data = await createDataSource(params)
                    if (data.status) {
                        Message.success(data.message)
                    } else {
                        Message.error(data.message)
                    }
                }
                done()
                search()
                resetDataSourceModalForm()
            } catch (err) {
                done(false) // 不关闭弹窗
            } finally {
                setLoading(false) // 加载结束
            }
        } else {
            // 表单验证失败
            done(false) // 不关闭弹窗
        }
    } catch (err) {
        Message.error('表单填写错误')
        done(false) // 验证失败时阻止弹窗关闭
    }
}

const handleCancel = () => {
    resetDataSourceModalForm()
    roleModalvisible.value = false
    setLoading(false)
}
const showcreateRole = () => {
    roleModalvisible.value = true
}

// 更新数据源
const updateRoleFirm = async (params: DataSourceRecord) => {
    setLoading(true) // 开始加载
    try {
        dataSourceModalForm.id = params.id
        dataSourceModalForm.name = params.name
        dataSourceModalForm.jdbcUrl = params.jdbcUrl
        dataSourceModalForm.username = params.username
        dataSourceModalForm.password = params.password
        dataSourceModalForm.remark = params.remark
        roleModalvisible.value = true
    } catch (err) {
        // 错误处理，可以使用 errorHandler 或其他方式
    } finally {
        setLoading(false) // 加载结束
    }
}

// 处理表格密度选择
const handleSelectDensity = (val: string | number | Record<string, any> | undefined, e: Event) => {
    size.value = val as SizeProps
}

onMounted(() => {
    fetchData()
})
</script>

<script lang="ts">
export default {
    name: 'UserManager'
}
</script>

<style scoped lang="less">
.container {
    padding: 0 20px 20px 20px;
}

:deep(.arco-table-th) {
    &:last-child {
        .arco-table-th-item-title {
            margin-left: 16px;
        }
    }
}

.action-icon {
    margin-left: 12px;
    cursor: pointer;
}

.active {
    color: #0960bd;
    background-color: #e3f4fc;
}

.nav-btn {
    margin-right: 5px;
}

.setting {
    display: flex;
    align-items: center;
    width: 200px;

    .title {
        margin-left: 12px;
        cursor: pointer;
    }
}

.username-block {
    display: flex;
    align-items: center;

    span {
        margin-left: 5px;
    }
}
</style>
